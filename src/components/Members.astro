---
import membersData from '../data/members.json';
const { members, slideshowImages } = membersData;
const sortedMembers = [...members].sort((a, b) => a.order - b.order);
---

<section class="section">
    <div class="container">
        <h2 class="section-title">MEMBERS</h2>

        <div class="members-content">
            <!-- スライドショー -->
            <div class="slideshow-wrapper">
                <div class="slideshow-container">
                    {slideshowImages.map((img, index) => (
                        <div class={`slideshow-slide ${index === 0 ? 'active' : ''}`}>
                            <img src={`/images/${img}`} alt={`NeoN Members Photo ${index + 1}`} />
                        </div>
                    ))}
                </div>
                <div class="slideshow-dots">
                    {slideshowImages.map((_, index) => (
                        <span class={`slideshow-dot ${index === 0 ? 'active' : ''}`} data-index={index}></span>
                    ))}
                </div>
            </div>

            <!-- メンバーグリッド -->
            <div class="members-grid">
                {sortedMembers.map((member) => (
                    <button class="member-btn" data-dj-id={member.id}>
                        {member.name}
                    </button>
                ))}
            </div>
        </div>
    </div>
</section>

<!-- モーダル -->
<div class="modal" id="djModal">
    <div class="modal-content">
        <span class="close-modal">&times;</span>
        <div class="dj-info">
            <div class="dj-photo-container">
                <img src="" id="modalDjPhoto" alt="DJ Photo" class="dj-photo">
            </div>
            <h3 class="dj-name" id="modalDjName"></h3>

            <div class="dj-link-container" id="modalDjLinkContainer" style="display: none;">
                <a href="" id="modalDjLink" target="_blank" rel="noopener" class="dj-external-link">
                    <span id="modalDjLinkText"></span>
                </a>
            </div>

            <div class="dj-qrcode-container" id="modalDjQrContainer" style="display: none;">
                <img src="" id="modalDjQrCode" alt="QR Code" class="dj-qrcode">
            </div>

            <div class="dj-social">
                <a href="" id="modalDjX" target="_blank" rel="noopener" class="social-link-modal">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                        <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"></path>
                    </svg>
                </a>
                <a href="" id="modalDjInsta" target="_blank" rel="noopener" class="social-link-modal" style="display: none;">
                    <i class="fab fa-instagram"></i>
                </a>
                <a href="" id="modalDjYoutube" target="_blank" rel="noopener" class="social-link-modal" style="display: none;">
                    <i class="fab fa-youtube"></i>
                </a>
                <a href="" id="modalDjTiktok" target="_blank" rel="noopener" class="social-link-modal" style="display: none;">
                    <i class="fab fa-tiktok"></i>
                </a>
            </div>
        </div>
    </div>
</div>

<script define:vars={{ members }}>
document.addEventListener('DOMContentLoaded', function() {
    // DJ情報マップ
    const djInfo = {};
    members.forEach(m => {
        djInfo[m.id] = {
            name: m.name,
            x: m.x,
            instagram: m.instagram || "",
            youtube: m.youtube || "",
            tiktok: m.tiktok || "",
            photo: `/images/${m.photo}`,
            externalLink: m.externalLink || "",
            externalLinkText: m.externalLinkText || "",
            qrCode: m.qrCode ? `/images/${m.qrCode}` : ""
        };
    });

    // モーダル
    const modal = document.getElementById('djModal');
    const closeBtn = document.querySelector('.close-modal');

    function openModal(djId) {
        const dj = djInfo[djId];
        if (!dj) return;

        document.getElementById('modalDjName').textContent = dj.name;
        document.getElementById('modalDjX').href = dj.x;
        document.getElementById('modalDjPhoto').src = dj.photo;
        document.getElementById('modalDjPhoto').alt = dj.name;

        const instaEl = document.getElementById('modalDjInsta');
        if (dj.instagram) {
            instaEl.href = dj.instagram;
            instaEl.style.display = 'flex';
        } else {
            instaEl.style.display = 'none';
        }

        const youtubeEl = document.getElementById('modalDjYoutube');
        if (dj.youtube) {
            youtubeEl.href = dj.youtube;
            youtubeEl.style.display = 'flex';
        } else {
            youtubeEl.style.display = 'none';
        }

        const tiktokEl = document.getElementById('modalDjTiktok');
        if (dj.tiktok) {
            tiktokEl.href = dj.tiktok;
            tiktokEl.style.display = 'flex';
        } else {
            tiktokEl.style.display = 'none';
        }

        const linkContainer = document.getElementById('modalDjLinkContainer');
        if (dj.externalLink) {
            document.getElementById('modalDjLink').href = dj.externalLink;
            document.getElementById('modalDjLinkText').textContent = dj.externalLinkText || 'Link';
            linkContainer.style.display = 'block';
        } else {
            linkContainer.style.display = 'none';
        }

        const qrContainer = document.getElementById('modalDjQrContainer');
        if (dj.qrCode) {
            document.getElementById('modalDjQrCode').src = dj.qrCode;
            qrContainer.style.display = 'block';
        } else {
            qrContainer.style.display = 'none';
        }

        modal.classList.add('show');
    }

    function closeModal() {
        modal.classList.remove('show');
    }

    document.querySelectorAll('.member-btn').forEach(btn => {
        btn.addEventListener('click', () => openModal(btn.dataset.djId));
    });

    closeBtn?.addEventListener('click', closeModal);
    modal?.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
    });

    // スライドショー
    let slideIndex = 0;
    const slides = document.querySelectorAll('.slideshow-slide');
    const dots = document.querySelectorAll('.slideshow-dot');
    let interval;

    function showSlide(index) {
        slides.forEach((s, i) => s.classList.toggle('active', i === index));
        dots.forEach((d, i) => d.classList.toggle('active', i === index));
    }

    function nextSlide() {
        slideIndex = (slideIndex + 1) % slides.length;
        showSlide(slideIndex);
    }

    function startAuto() {
        interval = setInterval(nextSlide, 5000);
    }

    function stopAuto() {
        clearInterval(interval);
    }

    dots.forEach((dot, i) => {
        dot.addEventListener('click', () => {
            stopAuto();
            slideIndex = i;
            showSlide(slideIndex);
            startAuto();
        });
    });

    const wrapper = document.querySelector('.slideshow-wrapper');
    wrapper?.addEventListener('mouseenter', stopAuto);
    wrapper?.addEventListener('mouseleave', startAuto);

    if (slides.length > 0) startAuto();
});
</script>
